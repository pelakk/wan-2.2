# ----------- STAGE 1: BASE TORCH ----------
FROM pytorch/pytorch:2.4.0-cuda12.1-cudnn8-runtime as base

RUN apt-get update && apt-get install -y git python3-opencv && rm -rf /var/lib/apt/lists/*

# Instalujemy tylko to, co jest potrzebne do dalszej pracy
RUN pip install --no-cache-dir opencv-python numpy==2.2.6

WORKDIR /ComfyUI

# ----------- STAGE 2: LIGHTWEIGHT BUILD ----------
FROM base as final

WORKDIR /ComfyUI

# Skopiuj pliki projektu
COPY . .

# Klonujemy tylko kilka repo na raz, żeby nie wywaliło się przez brak miejsca
RUN set -eux; \
    mkdir -p /ComfyUI/custom_nodes; \
    cd /ComfyUI/custom_nodes; \
    for repo in \
        https://github.com/ssitu/ComfyUI_UltimateSDUpscale.git \
        https://github.com/kijai/ComfyUI-KJNodes.git \
        https://github.com/rgthree/rgthree-comfy.git \
        https://github.com/JPS-GER/ComfyUI_JPS-Nodes.git \
        https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes.git \
        https://github.com/Kosinkadink/ComfyUI-VideoHelperSuite.git \
        https://github.com/ltdrdata/ComfyUI-Impact-Pack.git \
        https://github.com/Fannovel16/comfyui_controlnet_aux.git \
        https://github.com/yolain/ComfyUI-Easy-Use.git \
        https://github.com/kijai/ComfyUI-Florence2.git \
        https://github.com/WASasquatch/was-node-suite-comfyui.git \
        https://github.com/theUpsider/ComfyUI-Logic.git \
        https://github.com/cubiq/ComfyUI_essentials.git \
        https://github.com/chflame163/ComfyUI_LayerStyle.git; \
    do \
        git clone --depth 1 "$repo" || echo "Failed: $repo"; \
    done

RUN echo "✅ ComfyUI custom nodes installed successfully"
